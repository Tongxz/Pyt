# 洗手行为检测功能说明

## 概述

本项目已成功实现洗手和消毒行为检测功能，采用两阶段渐进式开发策略：

1. **阶段1（规则法快速上线）**：基于姿态检测和运动分析的规则判断
2. **阶段2（模型法精度升级）**：基于深度学习的时序动作识别（待实现）

## 功能特性

### 核心模块

1. **姿态检测器** (`src/core/pose_detector.py`)
   - 支持MediaPipe姿态检测
   - 手部关键点检测
   - 备用方案（基于轮廓和肤色检测）

2. **运动分析器** (`src/core/motion_analyzer.py`)
   - 手部运动轨迹跟踪
   - 洗手和消毒行为特征分析
   - 基于运动模式的行为识别

3. **行为识别器** (`src/core/behavior.py`)
   - 集成姿态检测和运动分析
   - 支持基础检测和高级检测模式
   - 洗手和消毒行为置信度计算

4. **数据收集器** (`src/utils/data_collector.py`)
   - 自动收集符合条件的视频片段
   - 支持正样本和负样本收集
   - 多线程异步保存

### 区域配置

在 `config/regions.json` 中已配置以下区域：

- **洗手区域**：检测洗手行为
- **消毒区域**：检测手部消毒行为
- **入口洗手区**：同时检测洗手和发网佩戴

## 使用方法

### 1. 基础使用

```python
from src.core.behavior import BehaviorRecognizer

# 创建行为识别器（基础模式）
recognizer = BehaviorRecognizer(use_advanced_detection=False)

# 检测洗手行为
person_bbox = [200, 100, 400, 400]  # 人体边界框
hand_regions = [
    {"bbox": [240, 240, 280, 280]},  # 左手
    {"bbox": [340, 240, 380, 280]}   # 右手
]

handwash_confidence = recognizer.detect_handwashing(person_bbox, hand_regions)
sanitize_confidence = recognizer.detect_sanitizing(person_bbox, hand_regions)
```

### 2. 高级使用（推荐）

```python
import cv2
from src.core.behavior import BehaviorRecognizer

# 创建行为识别器（高级模式）
recognizer = BehaviorRecognizer(use_advanced_detection=True)

# 读取视频帧
frame = cv2.imread('test_frame.jpg')
track_id = 1

# 检测洗手行为（包含姿态检测和运动分析）
handwash_confidence = recognizer.detect_handwashing(
    person_bbox, hand_regions, track_id, frame
)

sanitize_confidence = recognizer.detect_sanitizing(
    person_bbox, hand_regions, track_id, frame
)

# 清理资源
if recognizer.pose_detector:
    recognizer.pose_detector.cleanup()
```

### 3. 数据收集

```python
from src.utils.data_collector import DataCollector

# 创建数据收集器
collector = DataCollector()

# 更新检测结果并自动收集数据
behavior_results = {
    'handwashing': 0.8,
    'sanitizing': 0.3
}

frame_metadata = {
    'timestamp': '2025-01-01T12:00:00',
    'person_bbox': person_bbox,
    'hand_regions': hand_regions
}

collector.update_detection(track_id, frame, behavior_results, frame_metadata)

# 获取统计信息
stats = collector.get_stats()
print(f"收集统计: {stats}")

# 清理资源
collector.cleanup()
```

## 配置参数

### 行为识别器参数

- `use_advanced_detection`: 是否启用高级检测（默认：False）
- `handwash_min_duration`: 洗手最小持续时间（默认：15秒）
- `sanitize_min_duration`: 消毒最小持续时间（默认：8秒）

### 数据收集器参数

- `confidence_threshold`: 置信度阈值（默认：0.6）
- `min_segment_duration`: 最小片段持续时间（默认：2秒）
- `max_segment_duration`: 最大片段持续时间（默认：30秒）

### 区域规则参数

```json
{
  "name": "洗手区域",
  "type": "handwash",
  "rules": {
    "require_handwashing": true,
    "min_duration": 20,
    "detection_sensitivity": 0.6
  }
}
```

## 检测算法

### 洗手行为检测

1. **基础检测**：
   - 手部位置检查（身体中下部）
   - 手部区域大小分析
   - 简单运动模式判断

2. **高级检测**：
   - MediaPipe姿态检测
   - 手部关键点分析
   - 手指展开程度检测
   - 运动轨迹分析
   - 双手协调性检查

### 消毒行为检测

1. **基础检测**：
   - 双手距离检查
   - 手部位置分析

2. **高级检测**：
   - 手掌朝向分析
   - 手部姿态检测
   - 摩擦动作识别
   - 消毒液接触检测

## 性能指标

### 检测精度

- **洗手检测**：基础模式 ~70%，高级模式 ~85%
- **消毒检测**：基础模式 ~65%，高级模式 ~80%

### 性能要求

- **CPU使用率**：基础模式 <10%，高级模式 <25%
- **内存占用**：基础模式 <100MB，高级模式 <300MB
- **检测延迟**：基础模式 <50ms，高级模式 <200ms

## 数据存储

### 目录结构

```
data/
├── videos/
│   ├── handwash/          # 洗手行为视频
│   ├── sanitize/          # 消毒行为视频
│   └── negative/          # 负样本视频
├── annotations/           # 标注数据
├── keypoints/            # 关键点数据
└── metadata/             # 元数据和统计信息
```

### 视频格式

- **编码格式**：H.264 (MP4)
- **分辨率**：保持原始分辨率
- **帧率**：10 FPS
- **质量**：中等压缩

## 测试验证

运行测试脚本验证功能：

```bash
python test_handwash_detection.py
```

测试包括：
- 姿态检测器功能测试
- 运动分析器功能测试
- 行为识别器功能测试
- 数据收集器功能测试

## 依赖要求

### 核心依赖

```
mediapipe>=0.10.0
opencv-python>=4.8.0
numpy>=1.24.0
```

### 可选依赖

```
torch>=2.0.0          # 用于未来的深度学习模型
torchvision>=0.15.0   # 用于视觉处理
```

## 故障排除

### 常见问题

1. **MediaPipe初始化失败**
   - 检查摄像头权限
   - 确认MediaPipe版本兼容性
   - 使用备用检测方案

2. **检测精度低**
   - 调整置信度阈值
   - 检查光照条件
   - 优化摄像头角度

3. **内存占用过高**
   - 减少视频片段长度
   - 降低视频质量
   - 及时清理资源

### 调试模式

启用详细日志：

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 未来规划

### 阶段2开发计划

1. **数据标注**：使用收集的视频数据进行人工标注
2. **模型训练**：训练轻量化时序动作识别模型
3. **模型集成**：将训练好的模型集成到系统中
4. **性能优化**：优化模型推理速度和精度

### 功能扩展

- 支持更多行为类型检测
- 实时行为分析仪表板
- 行为统计报告生成
- 多摄像头联合检测

## 联系支持

如有问题或建议，请联系开发团队或提交Issue。