# 开发环境 Dockerfile
# Development Environment Dockerfile

FROM python:3.10-slim

# 设置工作目录
WORKDIR /app

# 设置环境变量
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive
ENV ENVIRONMENT=development

# 安装系统依赖和开发工具
RUN apt-get update && apt-get install -y \
    # OpenCV 依赖
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libgstreamer1.0-0 \
    libgstreamer-plugins-base1.0-0 \
    libgtk-3-0 \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    libv4l-dev \
    libxvidcore-dev \
    libx264-dev \
    libjpeg-dev \
    libpng-dev \
    libtiff-dev \
    libatlas-base-dev \
    gfortran \
    # 开发工具
    wget \
    curl \
    git \
    vim \
    nano \
    htop \
    tree \
    jq \
    unzip \
    build-essential \
    # 调试工具
    gdb \
    strace \
    tcpdump \
    netcat \
    && rm -rf /var/lib/apt/lists/*

# 复制requirements文件
COPY requirements.txt .

# 安装Python依赖和开发工具
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir \
        # 开发工具
        ipython \
        jupyter \
        jupyterlab \
        # 代码质量工具
        black \
        flake8 \
        mypy \
        isort \
        bandit \
        # 测试工具
        pytest \
        pytest-cov \
        pytest-mock \
        pytest-asyncio \
        # 调试工具
        pdb++ \
        ipdb \
        # 性能分析
        memory-profiler \
        line-profiler \
        # 文档工具
        sphinx \
        sphinx-rtd-theme

# 复制项目文件
COPY . .

# 创建必要的目录
RUN mkdir -p /app/data /app/logs /app/models /app/config /app/notebooks

# 设置权限
RUN chmod +x main.py

# 安装pre-commit hooks
RUN pip install pre-commit && \
    git config --global --add safe.directory /app

# 暴露端口
EXPOSE 8000 8080 8888 5000

# Jupyter配置
RUN jupyter lab --generate-config && \
    echo "c.ServerApp.ip = '0.0.0.0'" >> ~/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.port = 8888" >> ~/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.open_browser = False" >> ~/.jupyter/jupyter_lab_config.py && \
    echo "c.ServerApp.allow_root = True" >> ~/.jupyter/jupyter_lab_config.py

# 默认启动命令（开发模式）
CMD ["python", "main.py", "--mode", "api", "--debug"]